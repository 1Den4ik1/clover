# Использование Optical Flow

> **Warning** Данная функция является **экспериментальной** и включена в образ с версии v0.11.4.

При использовании технологии Optical Flow возможен полет в режиме POSCTL и автономные полеты по камере, направленной вниз, за счет измерения сдвигов текстуры поверхности пола.

## Включение

На данный момент для использования Optical Flow необходима [кастомная прошивка PX4](https://yadi.sk/d/KaxaIhohu4V8XA).

Необходимо использование дальномера. [Подключите и настройте дальномер VL53L1X](laser.md), используя инструкцию.

Включите Optical Flow в файле `~/catkin_ws/src/clever/clever/launch/clever.launch`:

```xml
<arg name="optical_flow" default="true"/>
```

> **Info** Для правильной работы модуль камеры должен быть корректно подключен и [сконфигурирован](camera.md).

## Настройка полетного контроллера

Рекомендуемые параметры PX4:

* `SYS_MC_EST_GROUP` – 2 (EKF2).
* `EKF2_AID_MASK` – use optical flow.
* `EKF2_OF_DELAY` – 0.
* `EKF2_OF_QMIN` – 20.
* `SENS_FLOW_ROT` – No rotation (отсутствие поворота).
* `EKF2_HGT_MODE` – range sensor (см. [конфигурирование дальномера](laser.md)).

## Полет в POSCTL

Настройте POSCTL как один из полетных режимов PX4. Переведите в режим POSCTL.

## Автономный полет

Автономный полет возможен с использованием модуля [simple_offboard](simple_offboard.md).

Пример взлета на высоту 1.5 м и удержание позиции:

```python
navigate(z=1.5, frame_id='body', auto_arm=True)
```

Полет вперед на 1 м:

```python
navigate(x=1.5, frame_id='body')
```

## Неисправности

При появлении в QGC ошибок типа `EKF INTERNAL CHECKS` попробуйте перезагрузить EKF2. Для этого наберите в MAVLink-консоли:

```nsh
ekf2 stop
ekf2 start
```

Если коптер сильно уплывает по рысканью, попробуйте:

* перекалибровать гироскопы;
* перекалибровать магнитометр;
* попробовать разные значения параметра `EKF2_MAG_TYPE`, который определяет, каким образом данные с магнитометра используются в EKF2;
* изменять значения параметров `EKF2_MAG_NOISE`, `EKF2_GYR_NOISE`, `EKF2_GYR_B_NOISE`.

Если коптер уплывает по высоте, попробуйте:

* Изменить значение параметра `MPC_THR_HOVER`;
* выставить `MPC_ALT_MODE` = 2 (Terrain following).
