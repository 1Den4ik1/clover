Предварительная настройка квадрокоптера
======

### 1. Состав пульта FLYSKY i6
---------------------
![Состав пульта](../img/consistofTransmitter.jpg)


### 2. Установка QGroundCongtrol
* Скачиваем установочный файл для Windows/iOS по ссылке [QGroundCongtrol](http://qgroundcontrol.com/downloads/).
* Соглашаемся с установкой драйверов при инсталяции

### 3. Форматирование карты памяти

* Устанавливаем карту памяти microSD в адаптер
* Форматируем карту в файловую систему FAT32
  правый клие на диске > Форматирование
* Выполняем "Безопасное извлечение" карты напанели инструментов, далее извлекаем карту
* Устанавливаем micrSD карту в полетный контроллер Pixhawk.

### 4. Обновление прошивки Pixhawk

![Обновление прошивки](../img/firmwarePX4.jpg)

1. Заходим в Vehicle Setup.
2. Выбираем Firmware.
3. Отключаем Pixhawk от USB. Подключаем Pixhawk к USB снова.
4. Ждем подключения Pixhawk,  выбираем прошивку PX4 Flight Stack и активируем Advanced settings.
5. Выбираем тип прошивки Standard Version (stable). Если загружать собственную прошивку/ прошивку внешним файлом (например, скачанную из интернета), то выбираем Customize из выпадающего меню.
6. Кликаем OK.
7. Отключаем Pixhawk от USB.
8. Подключаем Pixhawk к USB снова.

### 5. Настройка Pixhawk

![Главное окно](../img/mainWindow.jpg)

1. Системы, нуждающиеся в настройке: Airframe, Radio, Sensors, Flight Mode
2. Текущая прошивка контроллера.
3. Текущий полетный режим.
4. Сообщения об ошибках.

### 6. Выбор рамы

![ Выбор рамы](../img/airframeSetup.jpg)

1. Заходим в меню Airframe.
2. Выбираем тип рамы Quadrotor X.
3. Выбираем тип навесных элементов Generic Quadrotor X config
4. Перемещаемся в начало списка и сохраняем настройки Apply and Restart

![Внимание!](../img/attentionSave.jpg)

5. Повторно подтверждаем Apply
6. Ждем, пока Pixhawk  выполнит сохранение и перезагрузится

### 7. Подключение пульта

#### Убедитесь, что перед калибровкой:
  * К коптеру не подключено внешнее питание АКБ
  * Пропеллеры не установлены на моторах
  
1. Заходим в меню Radio
2. Включаем пульт, переводя переключатель Power в верхнее положение
3. Далее необходимо убедиться, что связь с приемником установлена:
  * На ЖК Экране пульта высвечивается индикация
  
  ![ Индикация пульта](../img/unblockView.jpg)
  
  * Светодиод на приемнике горит непрерывно красным
  
 При наличиии проблем с подключением щелкните ![здесь](../docs/radioerrors1.md)


### 8. Настройка режимных каналов

Каналы CH5 и CH6 необходимы для настройки полета коптера.
На канал CH5 назначаем 3-х позиционный переключатель SwC - будем изменять полетные режимы
На канал CH6 назначаем 2-х позиционный переключатель SwA - аварийная остановка моторов

![Используемые переключатели](../img/chooseSwitch.jpg)

#### Чтобы переназначить переключатели, выполните следующие действия:

1. Зайдите в МЕНЮ (удерживаем нажатой кнопку “ОК”)
2. Выберите меню “Functions setup” (Кнопки Up/Down - для навигации, кнопка “ОК” - подтверждение выбора
3. Выберите “Aux. channels”
4. Выберите 
 * Channel 5 - SwC
 * Channel 6 - SwA
5. Сохраните изменения (удерживаем нажатой кнопку “CANCEL”)

![Выбор каналов](../img/setupSwitch.jpg)

### 9. Калибровка пульта

Начинаем процедуру калибровки

1. Нажимаем кнопку Calibrate
2. Устанавливаем триммеры Throttle, Yaw, Pitch, Roll в 0. 
 * Триммеры позволяют задавать смещение коптеру. 
 * Чтобы установить один из триммеров в 0, необходимо на пульте переместить указатель в центр до длительного звукового сигнала (писка)
3. Жмем ОК

![Калибровка пульта Начало](../img/calibrateViewStart.jpg)

4. Переводим Левый стик (газ) (throttle) в минимум и кликаем Next
5. Калибровка каналов управления (throttle, yaw, pitch, roll). 
 Повторяем движения стиками вслед за анимацией и читаем подсказки.
6. Калибровка переключателей. 
 При появлении надписи Move all transmitter switches and/or dials back and forth to their extreme positions переключаем SwA..SwD, VrA,   VrB в их конечные положения. 
 Кликаем Next
7. Сохранение параметров.
 При появлении надписи "All settings have been captured. Click Next to write the new parameters to your board"
  Кликаем Next
  
8. Калибровка пульта завершена!

![Калибровка пульта](../img/calibrateView.jpg)


### 10. Калибровка акселерометра

1. Заходим в меню Sensors > Accelerometer
2. Поскольку направление Pixhawk совпадает с носом БПЛА, то выбираем Autopilot Orientation: ROTATION_NONE
   Кликаем OK
   
   ![Калибровка акселерометра](../img/calibrateaxcelstart.jpg)
   
3. Начинаем калибровку:
   Последовательно располагаем БПЛА как на картинках, когда Pixhawk захватит положение, вокруг картинки появится желтая рамка - удерживаем в этом положении БПЛА до переключения в зеленую рамку

 ![Калибровка акселерометра процесс](../img/calibrateaxcel.jpg)


### 11. Калибровка компаса

1. Заходим в меню Sensors > Compass
2. Поскольку направление Pixhawk совпадает с носом БПЛА, то выбираем Autopilot Orientation: ROTATION_NONE
   Кликаем OK
3. Начало калибровки.
* Выбираем ориентацию БПЛА как на картинке и ждем, когда Pixhawk определит положение БПЛА, появится желтая рамка и надпись "Rotate"
* Вращаем БПЛА как на картинке до появления зеленой рамки - Pixhawk откалибровал компас по данной оси.

![Калибровка компаса](../img/calibratecompass.jpg)

   
 ### 12. Калибровка гироскопа

1. Заходим в меню Sensors > Gyroscope
2. Устанавливаем БПЛА на ровную поверхность и кликаем OK
Ждем окончания калибровки. 

![Калибровка компаса](../img/calibrategyro.jpg)

 ##### Во время калибровки БПЛА не должен менять своего положения, шататься и т.д.

 
### 13. Полетные режимы

1. Заходим в меню Flight Modes
2. Устанавливаем переключатель каналов на переключатель SwC (Channel 5) 
   Mode channel - Channel 5
3. Переключая SwC, текущий режим подсвечивается желтым цветом.
4. Назначаем полетные режимы:
 * Flight Mode 1: Stabilized
 * Flight Mode 4: Altitude
 * Flight Mode 6: Hold
5. Отображение текущего полетного режима
6. Аварийное отключение моторов ставим на переключатель SwA (Channel 6). 
   Kill switch - Channel 6

![Полетные режимы](../img/flightModes.jpg)
   
   
 ### 14. Отключение Safety Switch

В полетном контроллере PIXHAWK стоит защита моторов от случайного использования.
Чтобы разблокировать коптер, необходимо отключить кнопку безопасности

1. Заходим в меню Parameters > Circuit Breaker
2. Выбираем параметр CBRK_AIRSPD_CHK, устанавливаем максимальное значение параметра (оно указано в строке Maximum Value окна Parameter Editor)
3. Сохраняем значения, кликая по кнопке Save
4. Повторяем установку максимальных значений для всех параметров, кроме CBRK_RATE_CTRL и CBRK_VELPOSERR

![Отключение кнопки безопасности](../img/turnoffSafetyswitch.jpg)
 
 
3. Залить прошивку PX4 последней версии. Для полетов в помещении на клевере – вариант с эстимейтором LPE.

TODO

4. Выбрать в QGroundControl раму, соответствующую раме коптера, например Quadrotor X (3DR DIY Quad) для квадрокоптера

TODO

5. Провести калибровки IMU, компаса, радиопульта.

TODO

Настройка для автономных полетов с использованием companion-computer (Raspberry Pi 3)
===

Основная статья: https://dev.px4.io/en/ros/offboard_control.html

6. Убедиться в коррекном подключении Raspberry Pi и PixHawk по UART.

7. Установить значение SYS_COMPANION на 921600 в параметрах.

8. Убедиться в работоспособности подключения, выполнив с Raspberry Pi:

```bash
rostopic echo /mavros/state
```

9. Отключить Safety Switch, если он не установлен, поменяв параметр CBRK_IO_SAFETY на 22027.

10. Включить land detector (если необходим режим AUTO.LAND), изменив значения параметра COM_DISARM_LAND. Подробнее: https://dev.px4.io/en/tutorials/land_detector.html

Настройка PX4 для использования marker_navigator
===

Для полетов по полю маркеров убедиться, что:

* SYS_MC_EST_GROUP = local_position_estimator
* В LPE_FUSION установлены **только** vision position, vision yaw, land detector. При желании, можно включить Baro (барометр).
* Выключен компас: ATT_W_MAG = 0
* Включена ориентация по Yaw по зрению: ATT_EXT_HDG_M = Vision
